name: Generate API Documentation

on:
  push:
    branches:
      - master
    paths:
      - 'include/**'
      - 'src/**'
      - 'docs/**'
      - 'Doxyfile'
      - 'README.md'
      - '.github/workflows/doxygen.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-docs:
    name: Build Doxygen Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen graphviz texlive-latex-base texlive-latex-extra texlive-fonts-recommended
      
      - name: Enable LaTeX generation in Doxyfile
        run: |
          # Temporarily enable LaTeX generation for workflow
          sed -i 's/GENERATE_LATEX         = NO/GENERATE_LATEX         = YES/' Doxyfile
          echo "âœ“ LaTeX generation enabled"
      
      - name: Generate Doxygen documentation
        run: |
          doxygen Doxyfile
      
      - name: Strip emojis from LaTeX files
        run: |
          if [ -d docs/doxygen/latex ]; then
            # Remove emoji patterns from all .tex files
            find docs/doxygen/latex -name "*.tex" -type f -exec sed -i 's/[ðŸ˜€-ðŸ™ðŸŒ€-ðŸ—¿ðŸš€-ðŸ›¿âœ€-âž¿]/[emoji]/g' {} + || true
            
            # Also remove specific unicode emoji ranges
            find docs/doxygen/latex -name "*.tex" -type f -exec sed -i 's/[\xF0\x9F][\x80-\xBF][\x80-\xBF][\x80-\xBF]//g' {} + || true
            
            # Remove zero-width characters and other problematic unicode
            find docs/doxygen/latex -name "*.tex" -type f -exec sed -i 's/[\u200B-\u200D\uFEFF]//g' {} + || true
            
            echo "âœ“ Emojis stripped from LaTeX files"
          fi
      
      - name: Build LaTeX PDF
        continue-on-error: true
        run: |
          if [ -d docs/doxygen/latex ]; then
            cd docs/doxygen/latex
            make pdf 2>&1 | tee build.log || echo "âš  LaTeX PDF build had errors (non-critical)"
            
            if [ -f refman.pdf ]; then
              echo "âœ… PDF successfully generated: refman.pdf"
            else
              echo "âŒ PDF generation failed, see build.log"
            fi
          fi
      
      - name: Prepare API branch (clean)
        run: |
          # Save current commit SHA and docs
          MASTER_SHA=$(git rev-parse --short HEAD)
          echo "MASTER_SHA=$MASTER_SHA" >> $GITHUB_ENV
          
          # Create temporary directory for docs
          mkdir -p /tmp/api-docs
          cp -r docs/doxygen/html /tmp/api-docs/
          
          # Copy LaTeX if exists
          if [ -d docs/doxygen/latex ]; then
            cp -r docs/doxygen/latex /tmp/api-docs/
            
            # Copy PDF if built
            if [ -f docs/doxygen/latex/refman.pdf ]; then
              mkdir -p /tmp/api-docs/pdf
              cp docs/doxygen/latex/refman.pdf /tmp/api-docs/pdf/FileVault-API.pdf
              echo "âœ… PDF copied"
            fi
          fi
          
          echo "âœ“ Docs saved to temp"
      
      - name: Create clean API branch
        run: |
          # Create orphan API branch (no history, clean slate)
          git checkout --orphan API
          
          # Remove all files from git index
          git rm -rf . 2>/dev/null || true
          
          # Copy only documentation
          mkdir -p doxygen
          cp -r /tmp/api-docs/html doxygen/
          
          if [ -d /tmp/api-docs/latex ]; then
            cp -r /tmp/api-docs/latex doxygen/
          fi
          
          if [ -d /tmp/api-docs/pdf ]; then
            cp -r /tmp/api-docs/pdf doxygen/
          fi
          
          echo "âœ“ Docs copied to clean API branch"
          
          # Create README for doxygen folder
          echo "# FileVault API Documentation" > doxygen/README.md
          echo "" >> doxygen/README.md
          echo "Auto-generated API documentation using Doxygen." >> doxygen/README.md
          echo "" >> doxygen/README.md
          echo "## Contents" >> doxygen/README.md
          echo "" >> doxygen/README.md
          echo "- **html/** - HTML documentation" >> doxygen/README.md
          echo "- **latex/** - LaTeX source files" >> doxygen/README.md
          echo "- **pdf/** - PDF documentation (if built)" >> doxygen/README.md
          echo "" >> doxygen/README.md
          echo "## View Documentation" >> doxygen/README.md
          echo "" >> doxygen/README.md
          echo "Open \`html/index.html\` in your browser." >> doxygen/README.md
          echo "" >> doxygen/README.md
          echo "Generated from master commit: $MASTER_SHA" >> doxygen/README.md
          
          # Create root README
          echo "# FileVault API Documentation" > README.md
          echo "" >> README.md
          echo "This branch contains only the auto-generated API documentation." >> README.md
          echo "" >> README.md
          echo "## Quick Start" >> README.md
          echo "" >> README.md
          echo "\`\`\`bash" >> README.md
          echo "# Clone only the API branch" >> README.md
          echo "git clone -b API --single-branch https://github.com/${{ github.repository }}.git filevault-docs" >> README.md
          echo "" >> README.md
          echo "# Open documentation" >> README.md
          echo "cd filevault-docs/doxygen/html" >> README.md
          echo "# Open index.html in your browser" >> README.md
          echo "\`\`\`" >> README.md
          echo "" >> README.md
          echo "**Documentation contents**: See [doxygen/README.md](doxygen/README.md)" >> README.md
          echo "" >> README.md
          echo "Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> README.md
          echo "" >> README.md
          echo "Source: master@$MASTER_SHA" >> README.md
          
          echo "âœ“ README files created"
      
      - name: Commit and push to API branch
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # Add only doxygen/ and README.md
          git add doxygen/ README.md
          
          # Commit with detailed message
          git commit -m "docs: Update API documentation from master@$MASTER_SHA

          Auto-generated Doxygen documentation
          
          Contents:
          - HTML documentation (doxygen/html/)
          - LaTeX sources (doxygen/latex/) - emoji-stripped
          - PDF documentation (doxygen/pdf/) - if built successfully
          
          Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Source: master branch commit $MASTER_SHA" || echo "No changes to commit"
          
          # Force push to replace API branch completely
          git push origin API --force
          
          echo "âœ“ Clean API branch pushed (only doxygen/ + README.md)"
      
      - name: Create deployment info
        run: |
          echo "## ðŸ“š Documentation Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Status**: Documentation successfully generated and deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‚ Output" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`API\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`$(git rev-parse --short HEAD)\`" >> $GITHUB_STEP_SUMMARY
          echo "- **HTML Size**: $(du -sh doxygen/html | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Access" >> $GITHUB_STEP_SUMMARY
          echo "Clone the API branch to view documentation:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "git clone -b API https://github.com/${{ github.repository }}.git filevault-docs" >> $GITHUB_STEP_SUMMARY
          echo "cd filevault-docs/doxygen/html" >> $GITHUB_STEP_SUMMARY
          echo "# Open index.html in browser" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
