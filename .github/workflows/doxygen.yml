name: Generate API Documentation

on:
  push:
    branches:
      - master
    paths:
      - 'include/**'
      - 'src/**'
      - 'docs/**'
      - 'Doxyfile'
      - 'README.md'
      - '.github/workflows/doxygen.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-docs:
    name: Build Doxygen Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            doxygen \
            graphviz \
            texlive-latex-base \
            texlive-latex-extra \
            texlive-fonts-recommended \
            texlive-fonts-extra \
            latexmk
      
      - name: Generate HTML documentation (with emojis)
        run: |
          echo "ðŸ“„ Generating HTML documentation..."
          doxygen Doxyfile.html
          
          if [ -d docs/doxygen-html/html ]; then
            echo "âœ… HTML docs generated: $(du -sh docs/doxygen-html/html | cut -f1)"
          else
            echo "âŒ HTML generation failed"
            exit 1
          fi
      
      - name: Generate LaTeX documentation (no emojis)
        run: |
          echo "ðŸ“š Generating LaTeX documentation..."
          doxygen Doxyfile.latex
          
          if [ -d docs/doxygen-latex/latex ]; then
            echo "âœ… LaTeX sources generated"
          else
            echo "âŒ LaTeX generation failed"
            exit 1
          fi
      
      - name: Build PDF from LaTeX
        continue-on-error: true
        run: |
          cd docs/doxygen-latex/latex
          
          echo "ðŸ”¨ Building PDF with pdflatex..."
          # Use make to build PDF (handles all dependencies)
          make pdf 2>&1 | tee build.log
          
          if [ -f refman.pdf ]; then
            PDF_SIZE=$(du -h refman.pdf | cut -f1)
            echo "âœ… PDF successfully generated: $PDF_SIZE"
            
            # Rename to more friendly name
            cp refman.pdf FileVault-API.pdf
          else
            echo "âš ï¸ PDF generation failed (non-critical)"
            echo "Check build.log for details"
          fi
      
      - name: Prepare API branch (clean)
        run: |
          # Save current commit SHA
          MASTER_SHA=$(git rev-parse --short HEAD)
          echo "MASTER_SHA=$MASTER_SHA" >> $GITHUB_ENV
          
          # Create temporary directory for docs
          mkdir -p /tmp/api-docs
          
          # Copy HTML documentation
          if [ -d docs/doxygen-html/html ]; then
            cp -r docs/doxygen-html/html /tmp/api-docs/
            echo "âœ… HTML copied"
          fi
          
          # Copy LaTeX sources
          if [ -d docs/doxygen-latex/latex ]; then
            cp -r docs/doxygen-latex/latex /tmp/api-docs/
            echo "âœ… LaTeX sources copied"
            
            # Copy PDF if successfully built
            if [ -f docs/doxygen-latex/latex/FileVault-API.pdf ]; then
              mkdir -p /tmp/api-docs/pdf
              cp docs/doxygen-latex/latex/FileVault-API.pdf /tmp/api-docs/pdf/
              echo "âœ… PDF copied ($(du -h /tmp/api-docs/pdf/FileVault-API.pdf | cut -f1))"
            else
              echo "âš ï¸ No PDF found (build may have failed)"
            fi
          fi
          
          echo "âœ“ All documentation saved to temp"
      
      - name: Create clean API branch
        run: |
          # Create orphan API branch (no history, clean slate)
          git checkout --orphan API
          
          # Remove all files from git index
          git rm -rf . 2>/dev/null || true
          
          # Copy only documentation
          mkdir -p doxygen
          cp -r /tmp/api-docs/html doxygen/
          
          if [ -d /tmp/api-docs/latex ]; then
            cp -r /tmp/api-docs/latex doxygen/
          fi
          
          if [ -d /tmp/api-docs/pdf ]; then
            cp -r /tmp/api-docs/pdf doxygen/
          fi
          
          echo "âœ“ Docs copied to clean API branch"
          
          # Copy README template and customize
          cp .github/workflows/API_README.md doxygen/README.md
          
          # Replace placeholders with actual stats
          sed -i "s/\*Auto-updated by workflow\*/$(date -u +"%Y-%m-%d %H:%M:%S UTC")/" doxygen/README.md
          sed -i "s/\*master branch\*/master@$MASTER_SHA/" doxygen/README.md
          
          if [ -f doxygen/html/index.html ]; then
            HTML_FILES=$(find doxygen/html -name "*.html" | wc -l)
            sed -i "s/\*Hundreds of pages\*/$HTML_FILES pages/" doxygen/README.md
          fi
          
          if [ -f doxygen/pdf/FileVault-API.pdf ]; then
            PDF_SIZE=$(du -h doxygen/pdf/FileVault-API.pdf | cut -f1)
            sed -i "s/\*Several MB\*/$PDF_SIZE/" doxygen/README.md
          fi
          
          echo "âœ“ README customized with stats"
          
          # Create root README
          echo "# FileVault API Documentation" > README.md
          echo "" >> README.md
          echo "This branch contains only the auto-generated API documentation." >> README.md
          echo "" >> README.md
          echo "## Quick Start" >> README.md
          echo "" >> README.md
          echo "\`\`\`bash" >> README.md
          echo "# Clone only the API branch" >> README.md
          echo "git clone -b API --single-branch https://github.com/${{ github.repository }}.git filevault-docs" >> README.md
          echo "" >> README.md
          echo "# Open documentation" >> README.md
          echo "cd filevault-docs/doxygen/html" >> README.md
          echo "# Open index.html in your browser" >> README.md
          echo "\`\`\`" >> README.md
          echo "" >> README.md
          echo "**Documentation contents**: See [doxygen/README.md](doxygen/README.md)" >> README.md
          echo "" >> README.md
          echo "Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> README.md
          echo "" >> README.md
          echo "Source: master@$MASTER_SHA" >> README.md
          
          echo "âœ“ README files created"
      
      - name: Commit and push to API branch
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # Add only doxygen/ and README.md
          git add doxygen/ README.md
          
          # Commit with detailed message
          git commit -m "docs: Update API documentation from master@$MASTER_SHA

          Auto-generated Doxygen documentation
          
          Contents:
          - HTML documentation (doxygen/html/)
          - LaTeX sources (doxygen/latex/) - emoji-stripped
          - PDF documentation (doxygen/pdf/) - if built successfully
          
          Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Source: master branch commit $MASTER_SHA" || echo "No changes to commit"
          
          # Force push to replace API branch completely
          git push origin API --force
          
          echo "âœ“ Clean API branch pushed (only doxygen/ + README.md)"
      
      - name: Create deployment info
        run: |
          echo "## ðŸ“š Documentation Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Status**: Documentation successfully generated and deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‚ Output" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`API\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`$(git rev-parse --short HEAD)\`" >> $GITHUB_STEP_SUMMARY
          echo "- **HTML Size**: $(du -sh doxygen/html | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Access" >> $GITHUB_STEP_SUMMARY
          echo "Clone the API branch to view documentation:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "git clone -b API https://github.com/${{ github.repository }}.git filevault-docs" >> $GITHUB_STEP_SUMMARY
          echo "cd filevault-docs/doxygen/html" >> $GITHUB_STEP_SUMMARY
          echo "# Open index.html in browser" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
