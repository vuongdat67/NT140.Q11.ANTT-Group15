# FileVault Release Pipeline
# Automatically build and release binaries for all platforms

name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

env:
  BUILD_TYPE: Release
  CONAN_VERSION: 2.22.2

jobs:
  # ===========================================
  # Windows Build
  # ===========================================
  build-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Install Conan & Ninja
      run: |
        pip install conan==${{ env.CONAN_VERSION }}
        choco install ninja -y

    - uses: actions/cache@v4
      with:
        path: ~/.conan2
        key: conan-windows-msvc-${{ hashFiles('conanfile.txt') }}
        restore-keys: conan-windows-msvc-

    - name: Setup Conan Profile
      shell: pwsh
      run: |
        $profileDir = "$env:USERPROFILE\.conan2\profiles"
        if (-not (Test-Path $profileDir)) { New-Item -ItemType Directory -Path $profileDir }
        $profile = @"
        [settings]
        arch=x86_64
        build_type=Release
        compiler=msvc
        compiler.cppstd=20
        compiler.runtime=dynamic
        compiler.version=194
        os=Windows
        [conf]
        tools.cmake.cmaketoolchain:generator=Ninja
        "@
        $profile | Out-File -FilePath "$profileDir\default" -Encoding utf8NoBOM

    - name: Install Dependencies
      shell: cmd
      run: |
        mkdir build
        cd build
        conan install .. --output-folder=. --build=missing

    - name: Configure CMake
      shell: cmd
      run: cmake --preset conan-release -DBUILD_TESTS=OFF

    - name: Build
      shell: cmd
      run: cmake --build build\build\Release --parallel

    - name: Create Package
      shell: pwsh
      run: |
        $version = "${{ github.ref_name }}" -replace '^v', ''
        New-Item -ItemType Directory -Force dist
        Copy-Item build\build\Release\bin\release\filevault.exe dist\
        Compress-Archive -Path dist\filevault.exe -DestinationPath "FileVault-$version-windows-x64.zip"

    - uses: actions/upload-artifact@v4
      with:
        name: filevault-windows-x64
        path: FileVault-*-windows-x64.zip

  # ===========================================
  # Linux Build
  # ===========================================
  build-linux:
    runs-on: ubuntu-24.04
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install GCC-13
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-13 g++-13 ninja-build
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-13 100
        sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-13 100

    - name: Install Conan
      run: pip install conan==${{ env.CONAN_VERSION }}

    - uses: actions/cache@v4
      with:
        path: ~/.conan2
        key: conan-linux-gcc13-release-${{ hashFiles('conanfile.txt') }}
        restore-keys: conan-linux-gcc13-

    - name: Setup Conan Profile
      run: |
        mkdir -p ~/.conan2/profiles
        cat > ~/.conan2/profiles/default << 'EOF'
        [settings]
        arch=x86_64
        build_type=Release
        compiler=gcc
        compiler.cppstd=20
        compiler.libcxx=libstdc++11
        compiler.version=13
        os=Linux
        [conf]
        tools.cmake.cmaketoolchain:generator=Ninja
        EOF

    - name: Install Dependencies
      run: |
        mkdir -p build && cd build
        conan install .. --output-folder=. --build=missing

    - name: Configure CMake
      run: cmake --preset conan-release -DBUILD_TESTS=OFF

    - name: Build
      run: cmake --build build/build/Release --parallel $(nproc)

    - name: Create Package
      run: |
        VERSION="${{ github.ref_name }}"
        VERSION="${VERSION#v}"
        mkdir -p dist
        cp build/build/Release/bin/release/filevault dist/
        chmod +x dist/filevault
        tar -czvf "FileVault-$VERSION-linux-x64.tar.gz" -C dist filevault

    - uses: actions/upload-artifact@v4
      with:
        name: filevault-linux-x64
        path: FileVault-*-linux-x64.tar.gz

  # ===========================================
  # macOS Build
  # ===========================================
  build-macos:
    runs-on: macos-14
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install Dependencies
      run: |
        brew install cmake ninja
        pip install conan==${{ env.CONAN_VERSION }}

    - uses: actions/cache@v4
      with:
        path: ~/.conan2
        key: conan-macos-${{ hashFiles('conanfile.txt') }}
        restore-keys: conan-macos-

    - name: Setup Conan Profile
      run: |
        mkdir -p ~/.conan2/profiles
        cat > ~/.conan2/profiles/default << 'EOF'
        [settings]
        arch=armv8
        build_type=Release
        compiler=apple-clang
        compiler.cppstd=20
        compiler.libcxx=libc++
        compiler.version=15
        os=Macos
        [conf]
        tools.cmake.cmaketoolchain:generator=Ninja
        EOF

    - name: Install Dependencies
      run: |
        mkdir -p build && cd build
        conan install .. --output-folder=. --build=missing

    - name: Configure CMake
      run: cmake --preset conan-release -DBUILD_TESTS=OFF

    - name: Build
      run: cmake --build build/build/Release --parallel

    - name: Create Package
      run: |
        VERSION="${{ github.ref_name }}"
        VERSION="${VERSION#v}"
        mkdir -p dist
        cp build/build/Release/bin/release/filevault dist/
        chmod +x dist/filevault
        tar -czvf "FileVault-$VERSION-macos-arm64.tar.gz" -C dist filevault

    - uses: actions/upload-artifact@v4
      with:
        name: filevault-macos-arm64
        path: FileVault-*-macos-arm64.tar.gz

  # ===========================================
  # Build VSCode Extension
  # ===========================================
  build-vscode-extension:
    runs-on: windows-latest
    
    defaults:
      run:
        working-directory: vscode
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: vscode/package-lock.json
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build extension
      run: npm run compile
    
    - name: Package VSIX
      run: npx vsce package --out filevault-extension.vsix
    
    - uses: actions/upload-artifact@v4
      with:
        name: filevault-vscode-extension
        path: vscode/filevault-extension.vsix

  # ===========================================
  # Build Tauri GUI (all platforms)
  # ===========================================
  build-tauri:
    strategy:
      fail-fast: false
      matrix:
        platform: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.platform }}
    defaults:
      run:
        working-directory: gui

    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'
        cache-dependency-path: 'gui/package-lock.json'

    - name: Install system dependencies (Linux)
      if: matrix.platform == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgtk-3-dev \
          libwebkit2gtk-4.1-dev \
          libayatana-appindicator3-dev \
          librsvg2-dev \
          patchelf \
          build-essential \
          curl \
          wget \
          file \
          libssl-dev

    - name: Install system dependencies (macOS)
      if: matrix.platform == 'macos-latest'
      run: |
        brew update
        brew install gtk+3

    - name: Install system dependencies (Windows)
      if: matrix.platform == 'windows-latest'
      run: |
        choco install -y nsis

    - name: Install frontend dependencies
      run: npm ci

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache Cargo registry and build
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          gui/src-tauri/target
        key: ${{ runner.os }}-cargo-${{ hashFiles('gui/src-tauri/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: Build and bundle Tauri app
      uses: tauri-apps/tauri-action@v0
      env:
        TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
        TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
      with:
        projectPath: gui
        args: --verbose

    - name: Find bundle files
      id: find-bundle
      shell: bash
      run: |
        BUNDLE_DIR="src-tauri/target/release/bundle"
        if [ -d "$BUNDLE_DIR" ]; then
          FILES=$(find "$BUNDLE_DIR" -type f \( -name "*.msi" -o -name "*.exe" -o -name "*.dmg" -o -name "*.app.tar.gz" -o -name "*.AppImage" -o -name "*.deb" -o -name "*.rpm" \) 2>/dev/null | head -20)
          if [ -n "$FILES" ]; then
            echo "$FILES"
            echo "bundle_exists=true" >> $GITHUB_OUTPUT
          else
            echo "⚠️ No bundle files found in $BUNDLE_DIR"
            echo "bundle_exists=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "⚠️ Bundle directory not found: $BUNDLE_DIR"
          echo "bundle_exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Upload Tauri installers
      if: steps.find-bundle.outputs.bundle_exists == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: tauri-gui-${{ matrix.platform }}
        path: |
          src-tauri/target/release/bundle/**/*.msi
          src-tauri/target/release/bundle/**/*.exe
          src-tauri/target/release/bundle/**/*.dmg
          src-tauri/target/release/bundle/**/*.app.tar.gz
          src-tauri/target/release/bundle/**/*.AppImage
          src-tauri/target/release/bundle/**/*.deb
          src-tauri/target/release/bundle/**/*.rpm
        if-no-files-found: warn

  # ===========================================
  # Create GitHub Release
  # ===========================================
  create-release:
    needs: [build-windows, build-linux, build-macos, build-vscode-extension, build-tauri]
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: List artifacts
      run: find artifacts -type f
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        name: FileVault ${{ github.ref_name }}
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          artifacts/filevault-windows-x64/*.zip
          artifacts/filevault-linux-x64/*.tar.gz
          artifacts/filevault-macos-arm64/*.tar.gz
          artifacts/filevault-vscode-extension/*.vsix
          artifacts/tauri-gui-ubuntu-latest/**/*
          artifacts/tauri-gui-macos-latest/**/*
          artifacts/tauri-gui-windows-latest/**/*
