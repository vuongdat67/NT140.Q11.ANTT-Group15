# FileVault CI/CD Pipeline
# Cross-platform build and test workflow

name: CI

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main ]

env:
  BUILD_TYPE: Release
  CONAN_VERSION: 2.22.2

jobs:
  # ===========================================
  # Linux Build - GCC
  # ===========================================
  build-linux-gcc:
    runs-on: ubuntu-24.04
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: ðŸ”§ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: ðŸ› ï¸ Install GCC-13
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-13 g++-13
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-13 100
        sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-13 100

    - name: ðŸ“¦ Install Conan
      run: |
        pip install conan==${{ env.CONAN_VERSION }}

    - name: ðŸ“¥ Cache Conan packages
      uses: actions/cache@v4
      with:
        path: ~/.conan2
        key: conan-linux-gcc13-${{ hashFiles('conanfile.txt') }}
        restore-keys: |
          conan-linux-gcc13-

    - name: ðŸ”¨ Configure Conan Profile
      run: |
        mkdir -p ~/.conan2/profiles
        cat > ~/.conan2/profiles/default << 'EOF'
        [settings]
        arch=x86_64
        build_type=Release
        compiler=gcc
        compiler.cppstd=20
        compiler.libcxx=libstdc++11
        compiler.version=13
        os=Linux
        EOF

    - name: ðŸ“¦ Install dependencies
      run: |
        mkdir -p build
        conan install . --output-folder=build --build=missing

    - name: ðŸ”¨ Configure CMake
      run: |
        cd build
        cmake .. -G "Unix Makefiles" \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DCMAKE_TOOLCHAIN_FILE=build/Release/generators/conan_toolchain.cmake \
          -DBUILD_TESTS=ON

    - name: ðŸ—ï¸ Build
      run: |
        cd build
        cmake --build . --parallel $(nproc)

    - name: ðŸ§ª Run Tests
      run: |
        cd build
        ctest --output-on-failure -j $(nproc)

    - name: ðŸ“¤ Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: filevault-linux-gcc13
        path: build/bin/release/filevault
        if-no-files-found: warn

  # ===========================================
  # Linux Build - Clang
  # ===========================================
  build-linux-clang:
    runs-on: ubuntu-24.04
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: ðŸ”§ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: ðŸ› ï¸ Install Clang-17 and libc++
      run: |
        wget https://apt.llvm.org/llvm.sh
        chmod +x llvm.sh
        sudo ./llvm.sh 17
        sudo apt-get install -y libc++-17-dev libc++abi-17-dev
        sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-17 100
        sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-17 100

    - name: ðŸ“¦ Install Conan
      run: |
        pip install conan==${{ env.CONAN_VERSION }}

    - name: ðŸ“¥ Cache Conan packages
      uses: actions/cache@v4
      with:
        path: ~/.conan2
        key: conan-linux-clang17-${{ hashFiles('conanfile.txt') }}
        restore-keys: |
          conan-linux-clang17-

    - name: ðŸ”¨ Configure Conan Profile
      run: |
        mkdir -p ~/.conan2/profiles
        cat > ~/.conan2/profiles/default << 'EOF'
        [settings]
        arch=x86_64
        build_type=Release
        compiler=clang
        compiler.cppstd=20
        compiler.libcxx=libc++
        compiler.version=17
        os=Linux
        EOF

    - name: ðŸ“¦ Install dependencies
      env:
        CC: clang-17
        CXX: clang++-17
      run: |
        mkdir -p build
        conan install . --output-folder=build --build=missing

    - name: ðŸ”¨ Configure CMake
      env:
        CC: clang-17
        CXX: clang++-17
      run: |
        cd build
        cmake .. -G "Unix Makefiles" \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DCMAKE_C_COMPILER=clang-17 \
          -DCMAKE_CXX_COMPILER=clang++-17 \
          -DCMAKE_TOOLCHAIN_FILE=build/Release/generators/conan_toolchain.cmake \
          -DBUILD_TESTS=ON

    - name: ðŸ—ï¸ Build
      run: |
        cd build
        cmake --build . --parallel $(nproc)

    - name: ðŸ§ª Run Tests
      run: |
        cd build
        ctest --output-on-failure -j $(nproc)

    - name: ðŸ“¤ Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: filevault-linux-clang17
        path: build/bin/release/filevault
        if-no-files-found: warn

  # ===========================================
  # Windows Build - MSVC (FIXED)
  # ===========================================
  build-windows-msvc:
    runs-on: windows-latest

    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: ðŸ”§ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: ðŸ› ï¸ Setup MSVC with Ninja
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: ðŸ“¦ Install Ninja
      shell: pwsh
      run: |
        choco install ninja -y
        ninja --version

    - name: ðŸ“¦ Install Conan
      run: |
        pip install conan==${{ env.CONAN_VERSION }}

    - name: ðŸ“¥ Cache Conan packages
      uses: actions/cache@v4
      with:
        path: ~/.conan2
        key: conan-windows-msvc-${{ hashFiles('conanfile.txt') }}
        restore-keys: |
          conan-windows-msvc-

    - name: ðŸ”¨ Configure Conan Profile
      shell: pwsh
      run: |
        $profileDir = Join-Path $env:USERPROFILE ".conan2\profiles"
        New-Item -ItemType Directory -Force -Path $profileDir | Out-Null
        $profile = @"
        [settings]
        arch=x86_64
        build_type=Release
        compiler=msvc
        compiler.cppstd=20
        compiler.runtime=dynamic
        compiler.version=194
        os=Windows
        "@
        $profilePath = Join-Path $profileDir "default"
        [System.IO.File]::WriteAllText($profilePath, $profile)
        
        Write-Host "Profile created:"
        Get-Content $profilePath

    - name: ðŸ“¦ Install dependencies
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path build
        conan install . --output-folder=build --build=missing

    - name: ðŸ”¨ Configure CMake
      shell: pwsh
      run: |
        cd build
        # Conan 2.x generates to build/build/generators (khÃ´ng cÃ³ /Release/)
        cmake .. -G "Ninja" `
          -DCMAKE_BUILD_TYPE="${{ env.BUILD_TYPE }}" `
          -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/build/build/generators/conan_toolchain.cmake" `
          -DBUILD_TESTS=ON

    - name: ðŸ—ï¸ Build
      shell: pwsh
      run: |
        cd build
        cmake --build . --parallel

    - name: ðŸ§ª Run Tests
      shell: pwsh
      run: |
        cd build
        ctest --output-on-failure -j $env:NUMBER_OF_PROCESSORS

    - name: ðŸ“¤ Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: filevault-windows-msvc
        path: build/bin/release/filevault.exe
        if-no-files-found: warn

  # ===========================================
  # Windows Build - MinGW (FIXED)
  # ===========================================
  build-windows-mingw:
    runs-on: windows-latest

    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: ðŸ› ï¸ Setup MinGW with MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: UCRT64
        update: true
        install: >-
          mingw-w64-ucrt-x86_64-gcc
          mingw-w64-ucrt-x86_64-cmake
          mingw-w64-ucrt-x86_64-ninja
          mingw-w64-ucrt-x86_64-python
          mingw-w64-ucrt-x86_64-python-pip

    - name: ðŸ“¥ Cache Conan packages
      uses: actions/cache@v4
      with:
        path: ~/.conan2
        key: conan-windows-mingw-${{ hashFiles('conanfile.txt') }}
        restore-keys: |
          conan-windows-mingw-

    - name: ðŸ“¦ Install Conan and Configure Profile
      shell: msys2 {0}
      run: |
        # Install Conan
        pip install --break-system-packages conan==${{ env.CONAN_VERSION }}
        
        # Táº¡o profile táº¡i Windows path (C:/Users/runneradmin/.conan2/profiles/)
        # KHÃ”NG dÃ¹ng ~/.conan2 vÃ¬ trong MSYS2 Ä‘Ã³ lÃ  path khÃ¡c
        PROFILE_DIR="/c/Users/runneradmin/.conan2/profiles"
        mkdir -p "$PROFILE_DIR"
        
        echo "[settings]" > "$PROFILE_DIR/default"
        echo "arch=x86_64" >> "$PROFILE_DIR/default"
        echo "build_type=Release" >> "$PROFILE_DIR/default"
        echo "compiler=gcc" >> "$PROFILE_DIR/default"
        echo "compiler.cppstd=20" >> "$PROFILE_DIR/default"
        echo "compiler.libcxx=libstdc++11" >> "$PROFILE_DIR/default"
        echo "compiler.version=14" >> "$PROFILE_DIR/default"
        echo "os=Windows" >> "$PROFILE_DIR/default"
        
        echo "=== MinGW GCC Profile ==="
        cat "$PROFILE_DIR/default"

    - name: ðŸ“¦ Install dependencies
      shell: msys2 {0}
      run: |
        mkdir -p build
        conan install . --output-folder=build --build=missing

    - name: ðŸ”¨ Configure CMake
      shell: msys2 {0}
      run: |
        cd build
        cmake .. -G "Ninja" \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DCMAKE_TOOLCHAIN_FILE=build/generators/conan_toolchain.cmake \
          -DBUILD_TESTS=ON

    - name: ðŸ—ï¸ Build
      shell: msys2 {0}
      run: |
        cd build
        cmake --build . --parallel $(nproc)

    - name: ðŸ§ª Run Tests
      shell: msys2 {0}
      run: |
        cd build
        ctest --output-on-failure -j $(nproc)

    - name: ðŸ“¤ Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: filevault-windows-mingw
        path: build/bin/release/filevault.exe
        if-no-files-found: warn

  # ===========================================
  # macOS Build
  # ===========================================
  build-macos:
    runs-on: macos-14  # Apple Silicon (ARM64)

    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: ðŸ”§ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: ðŸ“¦ Install Conan
      run: |
        pip install conan==${{ env.CONAN_VERSION }}

    - name: ðŸ“¥ Cache Conan packages
      uses: actions/cache@v4
      with:
        path: ~/.conan2
        key: conan-macos-arm64-${{ hashFiles('conanfile.txt') }}
        restore-keys: |
          conan-macos-arm64-

    - name: ðŸ”¨ Configure Conan Profile
      run: |
        mkdir -p ~/.conan2/profiles
        cat > ~/.conan2/profiles/default << 'EOF'
        [settings]
        arch=armv8
        build_type=Release
        compiler=apple-clang
        compiler.cppstd=20
        compiler.libcxx=libc++
        compiler.version=16
        os=Macos
        EOF

    - name: ðŸ“¦ Install dependencies
      run: |
        mkdir -p build
        conan install . --output-folder=build --build=missing

    - name: ðŸ”¨ Configure CMake
      run: |
        cd build
        cmake .. -G "Unix Makefiles" \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DCMAKE_TOOLCHAIN_FILE=build/Release/generators/conan_toolchain.cmake \
          -DCMAKE_OSX_ARCHITECTURES=arm64 \
          -DBUILD_TESTS=ON

    - name: ðŸ—ï¸ Build
      run: |
        cd build
        cmake --build . --parallel $(sysctl -n hw.ncpu)

    - name: ðŸ§ª Run Tests
      run: |
        cd build
        ctest --output-on-failure -j $(sysctl -n hw.ncpu)

    - name: ðŸ“¤ Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: filevault-macos-arm64
        path: build/bin/release/filevault
        if-no-files-found: warn

  # ===========================================
  # Code Quality Checks
  # ===========================================
  code-quality:
    runs-on: ubuntu-latest
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ðŸ” Check file encodings
      run: |
        echo "Checking for non-UTF-8 files..."
        find . -name "*.cpp" -o -name "*.hpp" -o -name "*.h" | \
          xargs -I {} sh -c 'file -i {} | grep -v "utf-8\|us-ascii" && echo "Warning: {} may not be UTF-8" || true'

    - name: ðŸ” Check line endings
      run: |
        echo "Checking for CRLF line endings in source files..."
        find . -name "*.cpp" -o -name "*.hpp" | \
          xargs -I {} sh -c 'grep -l $'"'"'\r'"'"' {} && echo "Warning: {} has CRLF" || true'

  # ===========================================
  # Release Job (only on tags)
  # ===========================================
  release:
    needs: [build-linux-gcc, build-linux-clang, build-windows-msvc, build-windows-mingw, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: ðŸ“¥ Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: ðŸ“¦ Create Release Archives
      run: |
        cd artifacts
        for dir in */; do
          name="${dir%/}"
          if [[ -f "$dir/filevault" ]]; then
            tar -czvf "${name}.tar.gz" -C "$dir" filevault
          elif [[ -f "$dir/filevault.exe" ]]; then
            zip -j "${name}.zip" "$dir/filevault.exe"
          fi
        done

    - name: ðŸš€ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: artifacts/*.tar.gz,artifacts/*.zip
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}