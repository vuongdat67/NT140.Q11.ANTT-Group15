# FileVault CI/CD Pipeline
# Cross-platform build and test workflow

name: CI

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main ]

env:
  BUILD_TYPE: Release
  CONAN_VERSION: 2.22.2

jobs:
  # ===========================================
  # Linux Build - GCC
  # ===========================================
  build-linux-gcc:
    runs-on: ubuntu-24.04
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: ğŸ”§ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: ğŸ› ï¸ Install GCC-13
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-13 g++-13
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-13 100
        sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-13 100

    - name: ğŸ“¦ Install Conan
      run: |
        pip install conan==${{ env.CONAN_VERSION }}

    - name: ğŸ“¥ Cache Conan packages
      uses: actions/cache@v4
      with:
        path: ~/.conan2
        key: conan-linux-gcc13-${{ hashFiles('conanfile.txt') }}
        restore-keys: |
          conan-linux-gcc13-

    - name: ğŸ”¨ Configure Conan Profile
      run: |
        conan profile detect --force
        conan profile update settings.compiler=gcc default
        conan profile update settings.compiler.version=13 default
        conan profile update settings.compiler.cppstd=20 default
        conan profile update settings.compiler.libcxx=libstdc++11 default

    - name: ğŸ“¦ Install dependencies
      run: |
        mkdir -p build
        conan install . --output-folder=build --build=missing

    - name: ğŸ”¨ Configure CMake
      run: |
        cd build
        cmake .. -G "Unix Makefiles" \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DCMAKE_TOOLCHAIN_FILE=build/Release/generators/conan_toolchain.cmake \
          -DBUILD_TESTS=ON

    - name: ğŸ—ï¸ Build
      run: |
        cd build
        cmake --build . --parallel $(nproc)

    - name: ğŸ§ª Run Tests
      run: |
        cd build
        ctest --output-on-failure -j $(nproc)

    - name: ğŸ“¤ Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: filevault-linux-gcc13
        path: build/bin/release/filevault
        if-no-files-found: warn

  # ===========================================
  # Linux Build - Clang
  # ===========================================
  build-linux-clang:
    runs-on: ubuntu-24.04
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: ğŸ”§ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: ğŸ› ï¸ Install Clang-17 and libc++
      run: |
        wget https://apt.llvm.org/llvm.sh
        chmod +x llvm.sh
        sudo ./llvm.sh 17
        sudo apt-get install -y libc++-17-dev libc++abi-17-dev
        sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-17 100
        sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-17 100

    - name: ğŸ“¦ Install Conan
      run: |
        pip install conan==${{ env.CONAN_VERSION }}

    - name: ğŸ“¥ Cache Conan packages
      uses: actions/cache@v4
      with:
        path: ~/.conan2
        key: conan-linux-clang17-${{ hashFiles('conanfile.txt') }}
        restore-keys: |
          conan-linux-clang17-

    - name: ğŸ”¨ Configure Conan Profile
      run: |
        conan profile detect --force
        conan profile update settings.compiler=clang default
        conan profile update settings.compiler.version=17 default
        conan profile update settings.compiler.cppstd=20 default
        conan profile update settings.compiler.libcxx=libc++ default

    - name: ğŸ“¦ Install dependencies
      env:
        CC: clang-17
        CXX: clang++-17
      run: |
        mkdir -p build
        conan install . --output-folder=build --build=missing

    - name: ğŸ”¨ Configure CMake
      env:
        CC: clang-17
        CXX: clang++-17
      run: |
        cd build
        cmake .. -G "Unix Makefiles" \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DCMAKE_C_COMPILER=clang-17 \
          -DCMAKE_CXX_COMPILER=clang++-17 \
          -DCMAKE_TOOLCHAIN_FILE=build/Release/generators/conan_toolchain.cmake \
          -DBUILD_TESTS=ON

    - name: ğŸ—ï¸ Build
      run: |
        cd build
        cmake --build . --parallel $(nproc)

    - name: ğŸ§ª Run Tests
      run: |
        cd build
        ctest --output-on-failure -j $(nproc)

    - name: ğŸ“¤ Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: filevault-linux-clang17
        path: build/bin/release/filevault
        if-no-files-found: warn

  # ===========================================
  # Windows Build - MSVC
  # ===========================================
  build-windows-msvc:
    runs-on: windows-latest

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: ğŸ”§ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: ğŸ› ï¸ Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: ğŸ“¦ Install Conan
      run: |
        pip install conan==${{ env.CONAN_VERSION }}

    - name: ğŸ“¥ Cache Conan packages
      uses: actions/cache@v4
      with:
        path: ~/.conan2
        key: conan-windows-msvc-${{ hashFiles('conanfile.txt') }}
        restore-keys: |
          conan-windows-msvc-

    - name: ğŸ”¨ Configure Conan Profile
      shell: pwsh
      run: |
        conan profile detect --force
        conan profile update settings.compiler=msvc default
        conan profile update settings.compiler.version=194 default
        conan profile update settings.compiler.cppstd=20 default
        conan profile update settings.compiler.runtime=dynamic default

    - name: ğŸ“¦ Install dependencies
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path build
        conan install . --output-folder=build --build=missing

    - name: ğŸ”¨ Configure CMake
      shell: pwsh
      run: |
        cd build
        # Sá»­ dá»¥ng Visual Studio generator thay vÃ¬ Ninja Ä‘á»ƒ trÃ¡nh lá»—i platform
        cmake .. -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_BUILD_TYPE="${{ env.BUILD_TYPE }}" `
          -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/build/build/generators/conan_toolchain.cmake" `
          -DBUILD_TESTS=ON

    - name: ğŸ—ï¸ Build
      shell: pwsh
      run: |
        cd build
        cmake --build . --config ${{ env.BUILD_TYPE }} --parallel

    - name: ğŸ§ª Run Tests
      shell: pwsh
      run: |
        cd build
        ctest --output-on-failure -C ${{ env.BUILD_TYPE }} -j $env:NUMBER_OF_PROCESSORS

    - name: ğŸ“¤ Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: filevault-windows-msvc
        path: build/bin/${{ env.BUILD_TYPE }}/filevault.exe
        if-no-files-found: warn

  # ===========================================
  # Windows Build - MinGW
  # ===========================================
  build-windows-mingw:
    runs-on: windows-latest

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: ğŸ› ï¸ Setup MinGW with MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: UCRT64
        update: true
        install: >-
          mingw-w64-ucrt-x86_64-gcc
          mingw-w64-ucrt-x86_64-cmake
          mingw-w64-ucrt-x86_64-ninja
          mingw-w64-ucrt-x86_64-python
          mingw-w64-ucrt-x86_64-python-pip

    - name: ğŸ“¥ Cache Conan packages
      uses: actions/cache@v4
      with:
        path: ~/.conan2
        key: conan-windows-mingw-${{ hashFiles('conanfile.txt') }}
        restore-keys: |
          conan-windows-mingw-

    - name: ğŸ“¦ Install Conan and Configure Profile
      shell: msys2 {0}
      run: |
        # Install Conan
        pip install --break-system-packages conan==${{ env.CONAN_VERSION }}
        
        # Sá»­ dá»¥ng profile detect thay vÃ¬ táº¡o thá»§ cÃ´ng
        conan profile detect --force
        conan profile update settings.compiler=gcc default
        conan profile update settings.compiler.version=14 default
        conan profile update settings.compiler.cppstd=20 default
        conan profile update settings.compiler.libcxx=libstdc++11 default
        conan profile update settings.os=Windows default
        
        echo "=== Profile created ==="
        conan profile show default

    - name: ğŸ“¦ Install dependencies
      shell: msys2 {0}
      run: |
        mkdir -p build
        conan install . --output-folder=build --build=missing

    - name: ğŸ”¨ Configure CMake
      shell: msys2 {0}
      run: |
        cd build
        cmake .. -G "Ninja" \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DCMAKE_TOOLCHAIN_FILE=build/Release/generators/conan_toolchain.cmake \
          -DBUILD_TESTS=ON

    - name: ğŸ—ï¸ Build
      shell: msys2 {0}
      run: |
        cd build
        cmake --build . --parallel $(nproc)

    - name: ğŸ§ª Run Tests
      shell: msys2 {0}
      run: |
        cd build
        ctest --output-on-failure -j $(nproc)

    - name: ğŸ“¤ Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: filevault-windows-mingw
        path: build/bin/release/filevault.exe
        if-no-files-found: warn

  # ===========================================
  # macOS Build
  # ===========================================
  build-macos:
    runs-on: macos-14  # Apple Silicon (ARM64)

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: ğŸ”§ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: ğŸ“¦ Install Conan
      run: |
        pip install conan==${{ env.CONAN_VERSION }}

    - name: ğŸ“¥ Cache Conan packages
      uses: actions/cache@v4
      with:
        path: ~/.conan2
        key: conan-macos-arm64-${{ hashFiles('conanfile.txt') }}
        restore-keys: |
          conan-macos-arm64-

    - name: ğŸ”¨ Configure Conan Profile
      run: |
        conan profile detect --force
        conan profile update settings.compiler=apple-clang default
        conan profile update settings.compiler.version=16 default
        conan profile update settings.compiler.cppstd=20 default
        conan profile update settings.arch=armv8 default

    - name: ğŸ“¦ Install dependencies
      run: |
        mkdir -p build
        conan install . --output-folder=build --build=missing

    - name: ğŸ”¨ Configure CMake
      run: |
        cd build
        cmake .. -G "Unix Makefiles" \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DCMAKE_TOOLCHAIN_FILE=build/Release/generators/conan_toolchain.cmake \
          -DCMAKE_OSX_ARCHITECTURES=arm64 \
          -DBUILD_TESTS=ON

    - name: ğŸ—ï¸ Build
      run: |
        cd build
        cmake --build . --parallel $(sysctl -n hw.ncpu)

    - name: ğŸ§ª Run Tests
      run: |
        cd build
        ctest --output-on-failure -j $(sysctl -n hw.ncpu)

    - name: ğŸ“¤ Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: filevault-macos-arm64
        path: build/bin/release/filevault
        if-no-files-found: warn

  # ===========================================
  # Code Quality Checks
  # ===========================================
  code-quality:
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ” Check file encodings
      run: |
        echo "Checking for non-UTF-8 files..."
        find . -name "*.cpp" -o -name "*.hpp" -o -name "*.h" | \
          xargs -I {} sh -c 'file -i {} | grep -v "utf-8\|us-ascii" && echo "Warning: {} may not be UTF-8" || true'

    - name: ğŸ“ Check line endings
      run: |
        echo "Checking for CRLF line endings in source files..."
        find . -name "*.cpp" -o -name "*.hpp" | \
          xargs -I {} sh -c 'grep -l $'"'"'\r'"'"' {} && echo "Warning: {} has CRLF" || true'

  # ===========================================
  # Release Job (only on tags)
  # ===========================================
  release:
    needs: [build-linux-gcc, build-linux-clang, build-windows-msvc, build-windows-mingw, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: ğŸ“¥ Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: ğŸ“¦ Create Release Archives
      run: |
        cd artifacts
        for dir in */; do
          name="${dir%/}"
          if [[ -f "$dir/filevault" ]]; then
            tar -czvf "${name}.tar.gz" -C "$dir" filevault
          elif [[ -f "$dir/filevault.exe" ]]; then
            zip -j "${name}.zip" "$dir/filevault.exe"
          fi
        done

    - name: ğŸš€ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: artifacts/*.tar.gz,artifacts/*.zip
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}