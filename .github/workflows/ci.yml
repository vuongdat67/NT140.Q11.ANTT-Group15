# FileVault CI/CD Pipeline
# Cross-platform build and test workflow

name: CI

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main ]

env:
  BUILD_TYPE: Release
  CONAN_VERSION: 2.14.0

jobs:
  # ===========================================
  # Linux Build
  # ===========================================
  build-linux:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        compiler: [gcc-13, clang-17]
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: ðŸ”§ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: ðŸ“¦ Install Conan
      run: |
        pip install conan==${{ env.CONAN_VERSION }}
        conan profile detect --force

    - name: ðŸ› ï¸ Install compiler (GCC-13)
      if: matrix.compiler == 'gcc-13'
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-13 g++-13
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-13 100
        sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-13 100

    - name: ðŸ› ï¸ Install compiler (Clang-17)
      if: matrix.compiler == 'clang-17'
      run: |
        wget https://apt.llvm.org/llvm.sh
        chmod +x llvm.sh
        sudo ./llvm.sh 17
        sudo apt-get install -y libc++-17-dev libc++abi-17-dev
        sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-17 100
        sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-17 100

    - name: ðŸ“¥ Cache Conan packages
      uses: actions/cache@v4
      with:
        path: ~/.conan2
        key: conan-linux-${{ matrix.compiler }}-${{ hashFiles('conanfile.txt') }}
        restore-keys: |
          conan-linux-${{ matrix.compiler }}-

    - name: ðŸ”¨ Configure Conan Profile (GCC)
      if: matrix.compiler == 'gcc-13'
      run: |
        conan profile detect --force
        echo "[settings]" > ~/.conan2/profiles/default
        echo "arch=x86_64" >> ~/.conan2/profiles/default
        echo "build_type=${{ env.BUILD_TYPE }}" >> ~/.conan2/profiles/default
        echo "compiler=gcc" >> ~/.conan2/profiles/default
        echo "compiler.cppstd=20" >> ~/.conan2/profiles/default
        echo "compiler.libcxx=libstdc++11" >> ~/.conan2/profiles/default
        echo "compiler.version=13" >> ~/.conan2/profiles/default
        echo "os=Linux" >> ~/.conan2/profiles/default

    - name: ðŸ”¨ Configure Conan Profile (Clang)
      if: matrix.compiler == 'clang-17'
      run: |
        conan profile detect --force
        cat > ~/.conan2/profiles/default << 'EOF'
        [settings]
        arch=x86_64
        build_type=${{ env.BUILD_TYPE }}
        compiler=clang
        compiler.cppstd=20
        compiler.libcxx=libc++
        compiler.version=17
        os=Linux
        
        [buildenv]
        CC=clang-17
        CXX=clang++-17
        EOF
        echo "os=Linux" >> ~/.conan2/profiles/default

    - name: ðŸ“¦ Install dependencies
      run: |
        mkdir -p build
        conan install . --output-folder=build --build=missing

    - name: ðŸ”¨ Configure CMake
      run: |
        cd build
        cmake .. -G "Unix Makefiles" \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DCMAKE_TOOLCHAIN_FILE=build/Release/generators/conan_toolchain.cmake \
          -DBUILD_TESTS=ON

    - name: ðŸ—ï¸ Build
      run: |
        cd build
        cmake --build . --parallel $(nproc)

    - name: ðŸ§ª Run Tests
      run: |
        cd build
        ctest --output-on-failure -j $(nproc)

    - name: ðŸ“¤ Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: filevault-linux-${{ matrix.compiler }}
        path: build/bin/release/filevault
        if-no-files-found: warn

  # ===========================================
  # Windows Build
  # ===========================================
  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        compiler: [msvc, mingw]

    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: ðŸ”§ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: ðŸ“¦ Install Conan
      run: |
        pip install conan==${{ env.CONAN_VERSION }}
        conan profile detect --force

    - name: ðŸ› ï¸ Setup MSVC
      if: matrix.compiler == 'msvc'
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: ðŸ› ï¸ Setup MinGW
      if: matrix.compiler == 'mingw'
      uses: msys2/setup-msys2@v2
      with:
        msystem: UCRT64
        update: true
        install: >-
          mingw-w64-ucrt-x86_64-gcc
          mingw-w64-ucrt-x86_64-cmake
          mingw-w64-ucrt-x86_64-ninja

    - name: ðŸ“¥ Cache Conan packages
      uses: actions/cache@v4
      with:
        path: ~/.conan2
        key: conan-windows-${{ matrix.compiler }}-${{ hashFiles('conanfile.txt') }}
        restore-keys: |
          conan-windows-${{ matrix.compiler }}-

    - name: ðŸ”¨ Configure Conan Profile (MSVC)
      if: matrix.compiler == 'msvc'
      shell: pwsh
      run: |
        conan profile detect --force
        @"
        [settings]
        arch=x86_64
        build_type=${{ env.BUILD_TYPE }}
        compiler=msvc
        compiler.cppstd=20
        compiler.runtime=dynamic
        compiler.version=193
        os=Windows
        "@ | Out-File -FilePath "$env:USERPROFILE\.conan2\profiles\default" -Encoding UTF8

    - name: ðŸ”¨ Configure Conan Profile (MinGW)
      if: matrix.compiler == 'mingw'
      shell: msys2 {0}
      run: |
        conan profile detect --force
        cat > ~/.conan2/profiles/default << 'EOF'
        [settings]
        arch=x86_64
        build_type=${{ env.BUILD_TYPE }}
        compiler=gcc
        compiler.cppstd=20
        compiler.libcxx=libstdc++11
        compiler.version=13
        os=Windows
        EOF

    - name: ðŸ“¦ Install dependencies (MSVC)
      if: matrix.compiler == 'msvc'
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path build
        conan install . --output-folder=build --build=missing

    - name: ðŸ“¦ Install dependencies (MinGW)
      if: matrix.compiler == 'mingw'
      shell: msys2 {0}
      run: |
        mkdir -p build
        conan install . --output-folder=build --build=missing

    - name: ðŸ”¨ Configure CMake (MSVC)
      if: matrix.compiler == 'msvc'
      shell: pwsh
      run: |
        cd build
        cmake .. -G "Ninja" `
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
          -DCMAKE_TOOLCHAIN_FILE="build/Release/generators/conan_toolchain.cmake" `
          -DBUILD_TESTS=ON

    - name: ðŸ”¨ Configure CMake (MinGW)
      if: matrix.compiler == 'mingw'
      shell: msys2 {0}
      run: |
        cd build
        cmake .. -G "Ninja" \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DCMAKE_TOOLCHAIN_FILE=build/Release/generators/conan_toolchain.cmake \
          -DBUILD_TESTS=ON

    - name: ðŸ—ï¸ Build (MSVC)
      if: matrix.compiler == 'msvc'
      shell: pwsh
      run: |
        cd build
        cmake --build . --parallel

    - name: ðŸ—ï¸ Build (MinGW)
      if: matrix.compiler == 'mingw'
      shell: msys2 {0}
      run: |
        cd build
        cmake --build . --parallel

    - name: ðŸ§ª Run Tests (MSVC)
      if: matrix.compiler == 'msvc'
      shell: pwsh
      run: |
        cd build
        ctest --output-on-failure -j $env:NUMBER_OF_PROCESSORS

    - name: ðŸ§ª Run Tests (MinGW)
      if: matrix.compiler == 'mingw'
      shell: msys2 {0}
      run: |
        cd build
        ctest --output-on-failure -j $(nproc)

    - name: ðŸ“¤ Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: filevault-windows-${{ matrix.compiler }}
        path: build/bin/release/filevault.exe
        if-no-files-found: warn

  # ===========================================
  # macOS Build
  # ===========================================
  build-macos:
    runs-on: macos-14  # Apple Silicon (ARM64)
    strategy:
      matrix:
        include:
          - arch: armv8
            runner_arch: arm64
          - arch: x86_64
            runner_arch: x86_64

    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: ðŸ”§ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: ðŸ“¦ Install Conan
      run: |
        pip install conan==${{ env.CONAN_VERSION }}
        conan profile detect --force

    - name: ðŸ“¥ Cache Conan packages
      uses: actions/cache@v4
      with:
        path: ~/.conan2
        key: conan-macos-${{ matrix.arch }}-${{ hashFiles('conanfile.txt') }}
        restore-keys: |
          conan-macos-${{ matrix.arch }}-

    - name: ðŸ”¨ Configure Conan Profile
      run: |
        conan profile detect --force
        cat > ~/.conan2/profiles/default << 'EOF'
        [settings]
        arch=${{ matrix.arch }}
        build_type=${{ env.BUILD_TYPE }}
        compiler=apple-clang
        compiler.cppstd=20
        compiler.libcxx=libc++
        compiler.version=15
        os=Macos
        EOF

    - name: ðŸ“¦ Install dependencies
      run: |
        mkdir -p build
        conan install . --output-folder=build --build=missing

    - name: ðŸ”¨ Configure CMake
      run: |
        cd build
        cmake .. -G "Unix Makefiles" \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DCMAKE_TOOLCHAIN_FILE=build/Release/generators/conan_toolchain.cmake \
          -DCMAKE_OSX_ARCHITECTURES=${{ matrix.runner_arch }} \
          -DBUILD_TESTS=ON

    - name: ðŸ—ï¸ Build
      run: |
        cd build
        cmake --build . --parallel $(sysctl -n hw.ncpu)

    - name: ðŸ§ª Run Tests
      if: matrix.runner_arch == 'arm64'  # Only run tests on native arch
      run: |
        cd build
        ctest --output-on-failure -j $(sysctl -n hw.ncpu)

    - name: ðŸ“¤ Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: filevault-macos-${{ matrix.arch }}
        path: build/bin/release/filevault
        if-no-files-found: warn

  # ===========================================
  # Code Quality Checks
  # ===========================================
  code-quality:
    runs-on: ubuntu-latest
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ðŸ” Check file encodings
      run: |
        echo "Checking for non-UTF-8 files..."
        find . -name "*.cpp" -o -name "*.hpp" -o -name "*.h" | \
          xargs -I {} sh -c 'file -i {} | grep -v "utf-8\|us-ascii" && echo "Warning: {} may not be UTF-8" || true'

    - name: ðŸ“ Check line endings
      run: |
        echo "Checking for CRLF line endings in source files..."
        find . -name "*.cpp" -o -name "*.hpp" | \
          xargs -I {} sh -c 'grep -l $'"'"'\r'"'"' {} && echo "Warning: {} has CRLF" || true'

  # ===========================================
  # Release Job (only on tags)
  # ===========================================
  release:
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: ðŸ“¥ Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: ðŸ“¦ Create Release Archives
      run: |
        cd artifacts
        for dir in */; do
          name="${dir%/}"
          if [[ -f "$dir/filevault" ]]; then
            tar -czvf "${name}.tar.gz" -C "$dir" filevault
          elif [[ -f "$dir/filevault.exe" ]]; then
            zip -j "${name}.zip" "$dir/filevault.exe"
          fi
        done

    - name: ðŸš€ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: artifacts/*.tar.gz,artifacts/*.zip
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
