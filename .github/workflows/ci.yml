# FileVault CI/CD Pipeline
# Cross-platform build with dynamic toolchain detection

name: CI

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main ]

env:
  BUILD_TYPE: Release
  CONAN_VERSION: 2.22.2

jobs:
  # ===========================================
  # Linux Build - GCC
  # ===========================================
  build-linux-gcc:
    runs-on: ubuntu-24.04
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install GCC-13
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-13 g++-13
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-13 100
        sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-13 100

    - name: Install Conan
      run: pip install conan==${{ env.CONAN_VERSION }}

    - uses: actions/cache@v4
      with:
        path: ~/.conan2
        key: conan-linux-gcc13-${{ hashFiles('conanfile.txt') }}
        restore-keys: conan-linux-gcc13-

    - name: Setup Conan Profile
      run: |
        mkdir -p ~/.conan2/profiles
        cat > ~/.conan2/profiles/default << 'EOF'
        [settings]
        arch=x86_64
        build_type=Release
        compiler=gcc
        compiler.cppstd=20
        compiler.libcxx=libstdc++11
        compiler.version=13
        os=Linux
        EOF

    - name: Install Dependencies
      run: |
        mkdir -p build && cd build
        conan install .. --output-folder=. --build=missing
        echo "=== DEBUG: Find toolchain ==="
        find . -name "conan_toolchain.cmake" -type f
        TOOLCHAIN=$(find . -name "conan_toolchain.cmake" -type f | head -1)
        echo "TOOLCHAIN_FILE=$TOOLCHAIN" >> $GITHUB_ENV

    - name: Configure & Build
      run: |
        cd build
        echo "Using toolchain: $TOOLCHAIN_FILE"
        cmake .. -G "Unix Makefiles" \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DCMAKE_TOOLCHAIN_FILE="$TOOLCHAIN_FILE" \
          -DBUILD_TESTS=ON
        cmake --build . --parallel $(nproc)

    - name: Test
      run: cd build && ctest --output-on-failure -j $(nproc)

    - uses: actions/upload-artifact@v4
      with:
        name: filevault-linux-gcc13
        path: build/bin/release/filevault
        if-no-files-found: warn

  # ===========================================
  # Linux Build - Clang
  # ===========================================
  build-linux-clang:
    runs-on: ubuntu-24.04
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install Clang-17
      run: |
        wget https://apt.llvm.org/llvm.sh
        chmod +x llvm.sh
        sudo ./llvm.sh 17
        sudo apt-get install -y libc++-17-dev libc++abi-17-dev

    - name: Install Conan
      run: pip install conan==${{ env.CONAN_VERSION }}

    - uses: actions/cache@v4
      with:
        path: ~/.conan2
        key: conan-linux-clang17-${{ hashFiles('conanfile.txt') }}
        restore-keys: conan-linux-clang17-

    - name: Setup Conan Profile
      run: |
        mkdir -p ~/.conan2/profiles
        cat > ~/.conan2/profiles/default << 'EOF'
        [settings]
        arch=x86_64
        build_type=Release
        compiler=clang
        compiler.cppstd=20
        compiler.libcxx=libc++
        compiler.version=17
        os=Linux
        EOF

    - name: Install Dependencies
      env:
        CC: clang-17
        CXX: clang++-17
      run: |
        mkdir -p build && cd build
        conan install .. --output-folder=. --build=missing
        TOOLCHAIN=$(find . -name "conan_toolchain.cmake" -type f | head -1)
        echo "TOOLCHAIN_FILE=$TOOLCHAIN" >> $GITHUB_ENV

    - name: Configure & Build
      env:
        CC: clang-17
        CXX: clang++-17
      run: |
        cd build
        cmake .. -G "Unix Makefiles" \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DCMAKE_C_COMPILER=clang-17 \
          -DCMAKE_CXX_COMPILER=clang++-17 \
          -DCMAKE_TOOLCHAIN_FILE="$TOOLCHAIN_FILE" \
          -DBUILD_TESTS=ON
        cmake --build . --parallel $(nproc)

    - name: Test
      run: cd build && ctest --output-on-failure -j $(nproc)

    - uses: actions/upload-artifact@v4
      with:
        name: filevault-linux-clang17
        path: build/bin/release/filevault
        if-no-files-found: warn

  # ===========================================
  # Windows Build - MSVC
  # ===========================================
  build-windows-msvc:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Install Tools
      run: |
        choco install ninja -y
        pip install conan==${{ env.CONAN_VERSION }}

    - uses: actions/cache@v4
      with:
        path: ~/.conan2
        key: conan-windows-msvc-${{ hashFiles('conanfile.txt') }}
        restore-keys: conan-windows-msvc-

    - name: Setup Conan Profile
      shell: pwsh
      run: |
        $profileDir = "$env:USERPROFILE\.conan2\profiles"
        New-Item -ItemType Directory -Force -Path $profileDir | Out-Null
        @"
        [settings]
        arch=x86_64
        build_type=Release
        compiler=msvc
        compiler.cppstd=20
        compiler.runtime=dynamic
        compiler.version=194
        os=Windows
        
        [conf]
        tools.cmake.cmaketoolchain:generator=Ninja
        "@ | Out-File -FilePath "$profileDir\default" -Encoding utf8NoBOM
        Write-Host "=== Profile ===" 
        Get-Content "$profileDir\default"

    - name: Install Dependencies
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path build | Out-Null
        cd build
        conan install .. --output-folder=. --build=missing -c tools.cmake.cmaketoolchain:generator=Ninja
        
        Write-Host "=== DEBUG: Directory structure ===" -ForegroundColor Cyan
        Get-ChildItem -Recurse -Filter "*.cmake" | Select-Object FullName
        
        $toolchain = Get-ChildItem -Recurse -Filter "conan_toolchain.cmake" | Select-Object -First 1
        if ($toolchain) {
          $path = $toolchain.FullName
          Write-Host "Found toolchain: $path" -ForegroundColor Green
          "TOOLCHAIN_FILE=$path" | Out-File -FilePath $env:GITHUB_ENV -Append
        } else {
          Write-Host "ERROR: Toolchain not found!" -ForegroundColor Red
          exit 1
        }

    - name: Configure & Build
      shell: pwsh
      run: |
        cd build
        Write-Host "Using toolchain: $env:TOOLCHAIN_FILE"
        cmake .. -G Ninja `
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
          -DCMAKE_TOOLCHAIN_FILE="$env:TOOLCHAIN_FILE" `
          -DBUILD_TESTS=ON
        cmake --build . --parallel

    - name: Test
      shell: pwsh
      run: |
        cd build
        ctest --output-on-failure -j $env:NUMBER_OF_PROCESSORS

    - uses: actions/upload-artifact@v4
      with:
        name: filevault-windows-msvc
        path: build/bin/release/filevault.exe
        if-no-files-found: warn

  # ===========================================
  # Windows Build - MinGW
  # ===========================================
  build-windows-mingw:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - uses: msys2/setup-msys2@v2
      with:
        msystem: UCRT64
        update: true
        install: >-
          mingw-w64-ucrt-x86_64-gcc
          mingw-w64-ucrt-x86_64-cmake
          mingw-w64-ucrt-x86_64-ninja
          mingw-w64-ucrt-x86_64-make
          mingw-w64-ucrt-x86_64-python
          mingw-w64-ucrt-x86_64-python-pip

    - uses: actions/cache@v4
      with:
        path: ~/.conan2
        key: conan-windows-mingw-${{ hashFiles('conanfile.txt') }}
        restore-keys: conan-windows-mingw-

    - name: Setup Conan & Profile
      shell: msys2 {0}
      run: |
        pip install --break-system-packages conan==${{ env.CONAN_VERSION }}
        
        # Create profile at BOTH locations to be safe
        for PROFILE_DIR in "/c/Users/$USER/.conan2/profiles" "$HOME/.conan2/profiles"; do
          mkdir -p "$PROFILE_DIR"
          {
            echo "[settings]"
            echo "arch=x86_64"
            echo "build_type=Release"
            echo "compiler=gcc"
            echo "compiler.cppstd=20"
            echo "compiler.libcxx=libstdc++11"
            echo "compiler.version=14"
            echo "os=Windows"
            echo ""
            echo "[conf]"
            echo "tools.cmake.cmaketoolchain:generator=Ninja"
            echo "tools.gnu:make_program=/ucrt64/bin/mingw32-make.exe"
          } > "$PROFILE_DIR/default"
          echo "Created profile at: $PROFILE_DIR/default"
        done
        
        echo "=== Profile content ==="
        cat "$HOME/.conan2/profiles/default"

    - name: Install Dependencies
      shell: msys2 {0}
      run: |
        mkdir -p build && cd build
        conan install .. --output-folder=. --build=missing -c tools.cmake.cmaketoolchain:generator=Ninja -c tools.gnu:make_program=/ucrt64/bin/mingw32-make.exe
        
        echo "=== DEBUG: Find toolchain ==="
        find . -name "conan_toolchain.cmake" -type f
        
        TOOLCHAIN=$(find . -name "conan_toolchain.cmake" -type f | head -1)
        if [ -n "$TOOLCHAIN" ]; then
          echo "Found toolchain: $TOOLCHAIN"
          echo "$TOOLCHAIN" > toolchain_path.txt
        else
          echo "ERROR: Toolchain not found!"
          exit 1
        fi

    - name: Configure & Build
      shell: msys2 {0}
      run: |
        cd build
        TOOLCHAIN=$(cat toolchain_path.txt)
        echo "Using toolchain: $TOOLCHAIN"
        cmake .. -G Ninja \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DCMAKE_TOOLCHAIN_FILE="$TOOLCHAIN" \
          -DBUILD_TESTS=ON
        cmake --build . --parallel $(nproc)

    - name: Test
      shell: msys2 {0}
      run: cd build && ctest --output-on-failure -j $(nproc)

    - uses: actions/upload-artifact@v4
      with:
        name: filevault-windows-mingw
        path: build/bin/release/filevault.exe
        if-no-files-found: warn

  # ===========================================
  # macOS Build
  # ===========================================
  build-macos:
    runs-on: macos-14

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install Conan
      run: pip install conan==${{ env.CONAN_VERSION }}

    - uses: actions/cache@v4
      with:
        path: ~/.conan2
        key: conan-macos-arm64-${{ hashFiles('conanfile.txt') }}
        restore-keys: conan-macos-arm64-

    - name: Setup Conan Profile
      run: |
        mkdir -p ~/.conan2/profiles
        cat > ~/.conan2/profiles/default << 'EOF'
        [settings]
        arch=armv8
        build_type=Release
        compiler=apple-clang
        compiler.cppstd=20
        compiler.libcxx=libc++
        compiler.version=16
        os=Macos
        EOF

    - name: Install Dependencies
      run: |
        mkdir -p build && cd build
        conan install .. --output-folder=. --build=missing
        TOOLCHAIN=$(find . -name "conan_toolchain.cmake" -type f | head -1)
        echo "TOOLCHAIN_FILE=$TOOLCHAIN" >> $GITHUB_ENV

    - name: Configure & Build
      run: |
        cd build
        cmake .. -G "Unix Makefiles" \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DCMAKE_TOOLCHAIN_FILE="$TOOLCHAIN_FILE" \
          -DCMAKE_OSX_ARCHITECTURES=arm64 \
          -DBUILD_TESTS=ON
        cmake --build . --parallel $(sysctl -n hw.ncpu)

    - name: Test
      run: cd build && ctest --output-on-failure -j $(sysctl -n hw.ncpu)

    - uses: actions/upload-artifact@v4
      with:
        name: filevault-macos-arm64
        path: build/bin/release/filevault
        if-no-files-found: warn

  # ===========================================
  # Code Quality
  # ===========================================
  code-quality:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Check encodings
      run: |
        find . -name "*.cpp" -o -name "*.hpp" | \
          xargs -I {} sh -c 'file -i {} | grep -v "utf-8\|us-ascii" || true'

  # ===========================================
  # Release
  # ===========================================
  release:
    needs: [build-linux-gcc, build-linux-clang, build-windows-msvc, build-windows-mingw, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Create Archives
      run: |
        cd artifacts
        for dir in */; do
          name="${dir%/}"
          if [[ -f "$dir/filevault" ]]; then
            tar -czvf "${name}.tar.gz" -C "$dir" filevault
          elif [[ -f "$dir/filevault.exe" ]]; then
            zip -j "${name}.zip" "$dir/filevault.exe"
          fi
        done

    - uses: softprops/action-gh-release@v1
      with:
        files: artifacts/*.tar.gz,artifacts/*.zip
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
